
from ultralytics import YOLO
import os
import torch
import numpy as np


# 절대 경로로 WEIGHTS_PATH 정의
WEIGHTS_PATH = "/home/jovyan/data-vol-1/Result/YOLO/1STEP_yolov11m/1STEP_yolov11m.pt"

# 모델 테스트 함수
def test_model():
    # 테스트 이미지 및 정답 레이블 폴더 경로 설정
    test_image_folder = '/home/jovyan/data-vol-1/dataset/test/images_test'
    output_dir = '/home/jovyan/data-vol-1/Result/DataPre/mode_1_rotation/base'
    
    results_folder = os.path.join(output_dir, '1STEP_YOLO_result')
    os.makedirs(results_folder, exist_ok=True)  # 결과 폴더가 없으면 생성

    # YOLO 모델 로드
    model = YOLO(WEIGHTS_PATH)

    # 모델 예측
    results = model.predict(
        source=test_image_folder,  # 테스트할 이미지 폴더 경로
        save=True,                 # 결과 이미지를 저장
        project=results_folder,    # 저장할 기본 디렉토리
        name="1STEP_YOLO_result"   # 결과를 저장할 하위 폴더 이름
    )

    # 클래스별 OBB 위치를 저장할 TXT 파일 경로 설정
    bbox_results_path = os.path.join(results_folder, 'bounding_boxes.txt')
    with open(bbox_results_path, 'w') as f:
        for result in results:
            image_name = os.path.basename(result.path)  # 이미지 이름
            f.write(f"Image: {image_name}\n")  # 이미지 이름 기록
            
            # 예측된 OBB 정보 처리
            if result.obb is not None:
                print(f"OBB for {image_name}: {result.obb.xyxyxyxy}")  # OBB 정보 출력
                
                for obb in result.obb.xyxyxyxy:  # OBB 좌표 정보
                    cls = obb[0].tolist()  # 클래스 ID를 첫 번째 요소에서 가져옴
                    xy_points = obb[1:]  # 나머지 8개 좌표
                    
                    # 좌표를 문자열로 변환
                    points_str = ', '.join([f'({point[0].item()}, {point[1].item()})' for point in xy_points])
                    f.write(f'Class: {cls}, OBB Points: {points_str}\n')  # OBB 좌표 기록
                    
            else:
                f.write("No OBB detected.\n")  # 감지된 OBB가 없는 경우 기록

            f.write("\n")  # 각 이미지 블록 사이에 줄 추가

    print(f"Test results saved to: {results_folder}")
    print(f"Bounding boxes saved to: {bbox_results_path}")

# 테스트 실행
test_model()
