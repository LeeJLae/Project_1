import cv2
import numpy as np
import os
import albumentations as A

# 원본 이미지와 라벨 폴더 경로
train_image_dir = '/home/jovyan/data-vol-1/Y_T_image2'
train_label_dir = '/home/jovyan/data-vol-1/Y_T_Txt'

# 증강된 이미지 및 라벨 파일을 저장할 폴더 생성
augmented_image_dir = os.path.join(train_image_dir, 'obb_image')
augmented_label_dir = os.path.join(train_label_dir, 'obb_label')
os.makedirs(augmented_image_dir, exist_ok=True)
os.makedirs(augmented_label_dir, exist_ok=True)

# 이미지와 바운딩 박스 좌표를 회전시키는 함수
def rotate_bounding_box(x_center, y_center, width, height, angle, image_shape):
    # 이미지 중심 좌표
    h, w = image_shape[:2]
    cx, cy = w / 2, h / 2
    
    # 각도 변환 행렬 계산
    angle_rad = np.radians(angle)
    cos_a = np.cos(angle_rad)
    sin_a = np.sin(angle_rad)
    
    # 바운딩 박스 중심을 이미지 중심으로 이동
    x_center_shifted = x_center * w - cx
    y_center_shifted = y_center * h - cy
    
    # 회전 변환 적용
    x_rot = cos_a * x_center_shifted - sin_a * y_center_shifted + cx
    y_rot = sin_a * x_center_shifted + cos_a * y_center_shifted + cy
    
    # 좌표를 다시 [0, 1] 범위로 정규화
    x_center_new = x_rot / w
    y_center_new = y_rot / h
    
    return x_center_new, y_center_new, width, height

# 데이터 증강 및 회전 적용 함수 (이미지도 저장)
def augment_image_and_label(image_path, label_path):
    image = cv2.imread(image_path)
    label_file = open(label_path, 'r')
    labels = label_file.readlines()
    label_file.close()

    for angle in np.arange(-50, 50.5, 0.5):  
        # 데이터 증강 설정 (각도별 회전)
        transform = A.Compose([
            A.Rotate(limit=(angle, angle), border_mode=cv2.BORDER_CONSTANT, p=1.0),  # 각도를 고정해서 회전
        ])

        # 이미지 증강
        augmented = transform(image=image)
        augmented_image = augmented['image']

        # 증강된 이미지 파일 저장
        augmented_image_filename = os.path.basename(image_path).replace('.png', f'_rot{angle}.png')
        augmented_image_path = os.path.join(augmented_image_dir, augmented_image_filename)
        cv2.imwrite(augmented_image_path, augmented_image)

        # 증강된 라벨 파일 저장
        filename = os.path.basename(image_path).replace('.png', f'_rot{angle}.txt')
        augmented_label_path = os.path.join(augmented_label_dir, filename)

        with open(augmented_label_path, 'w') as f:
            for label in labels:
                class_id, x_center, y_center, width, height = map(float, label.strip().split())
                # 바운딩 박스 좌표를 회전 변환
                x_center_new, y_center_new, width_new, height_new = rotate_bounding_box(
                    x_center, y_center, width, height, angle, image.shape
                )
                # 클래스 넘버(class_id)와 회전 각도(angle) 값을 추가
                f.write(f"{int(class_id)} {x_center_new} {y_center_new} {width_new} {height_new} {angle}\n")

# 학습 데이터에 대해 모든 각도(-90 ~ 90) 증강 적용
for image_file in os.listdir(train_image_dir):
    if image_file.endswith('.png'):  # PNG 파일을 대상으로 작업
        image_path = os.path.join(train_image_dir, image_file)
        label_path = os.path.join(train_label_dir, image_file.replace('.png', '.txt'))
        augment_image_and_label(image_path, label_path)
