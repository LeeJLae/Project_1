import cv2
import numpy as np
import os
import albumentations as A

# 원본 이미지와 라벨 폴더 경로
train_image_dir = '/home/jovyan/Y_T_Image'
train_label_dir = '/home/jovyan/Y_T_Txt'

# 증강된 라벨 파일을 저장할 폴더 생성
augmented_label_dir = os.path.join(train_label_dir, 'augmented_labels_obb')
os.makedirs(augmented_label_dir, exist_ok=True)

# 이미지와 바운딩 박스 좌표를 회전시키는 함수
def rotate_bounding_box(x_center, y_center, width, height, angle, image_shape):
    # 이미지 중심 좌표
    h, w = image_shape[:2]
    cx, cy = w / 2, h / 2
    
    # 각도 변환 행렬 계산
    angle_rad = np.radians(angle)
    cos_a = np.cos(angle_rad)
    sin_a = np.sin(angle_rad)
    
    # 바운딩 박스 중심을 이미지 중심으로 이동
    x_center_shifted = x_center * w - cx
    y_center_shifted = y_center * h - cy
    
    # 회전 변환 적용
    x_rot = cos_a * x_center_shifted - sin_a * y_center_shifted + cx
    y_rot = sin_a * x_center_shifted + cos_a * y_center_shifted + cy
    
    # 좌표를 다시 [0, 1] 범위로 정규화
    x_center_new = x_rot / w
    y_center_new = y_rot / h
    
    return x_center_new, y_center_new, width, height

# 데이터 증강 및 회전 적용 함수 (이미지는 저장하지 않음)
def augment_label_only(image_path, label_path):
    image = cv2.imread(image_path)
    label_file = open(label_path, 'r')
    labels = label_file.readlines()
    label_file.close()

    for angle in range(-180, 181):  # -180 ~ 180도까지 1도씩 회전
        # 데이터 증강 설정 (각도별 회전)
        transform = A.Compose([
            A.Rotate(limit=(angle, angle), border_mode=cv2.BORDER_CONSTANT, p=1.0),  # 각도를 고정해서 회전
        ])

        # 이미지 증강 (이미지는 저장하지 않음)
        augmented = transform(image=image)
        augmented_image = augmented['image']

        # 증강된 라벨 파일 저장
        filename = os.path.basename(image_path).replace('.jpg', f'_rot{angle}.txt')
        augmented_label_path = os.path.join(augmented_label_dir, filename)

        with open(augmented_label_path, 'w') as f:
            for label in labels:
                class_id, x_center, y_center, width, height = map(float, label.strip().split())
                # 바운딩 박스 좌표를 회전 변환
                x_center_new, y_center_new, width_new, height_new = rotate_bounding_box(
                    x_center, y_center, width, height, angle, image.shape
                )
                # 회전 각도(angle) 값을 추가
                f.write(f"{x_center_new} {y_center_new} {width_new} {height_new} {angle}\n")

# 학습 데이터에 대해 모든 각도(-180 ~ 180) 증강 적용
for image_file in os.listdir(train_image_dir):
    if image_file.endswith('.jpg'):
        image_path = os.path.join(train_image_dir, image_file)
        label_path = os.path.join(train_label_dir, image_file.replace('.jpg', '.txt'))
        augment_label_only(image_path, label_path)

